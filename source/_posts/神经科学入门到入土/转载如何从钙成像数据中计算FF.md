---
title: 【转载】如何从钙成像数据中计算ΔF／F
date: '2025-04-27 16:41:58'
updated: '2025-04-27 18:15:12'
categories:
  - 神经科学入门到入土
permalink: /post/reprint-how-to-calculate-df-f-from-calcium-imaging-data-zi5thg.html
comments: true
toc: true
---



原文：[How to compute ΔF/F from calcium imaging data | Scientifica](https://www.scientifica.uk.com/learning-zone/how-to-compute-%CE%B4f-f-from-calcium-imaging-data)

原文作者：**Peter Rupprecht 博士，苏黎世大学**

翻译作者：Achuan-2

**核心要点**

- ∆F/F 反映细胞内钙离子水平，但通常呈非线性关系。
- ∆F/F 最初于 20 世纪 80 年代为有机染料钙指示剂引入。
- 由于基线亮度低且具有非线性，GCaMP 的行为有所不同。
- 计算 ∆F/F 没有唯一的标准方法。
- ∆F/F 的计算必须根据细胞类型、活动模式和噪声进行调整。
- 解读 ∆F/F 需要了解指示剂、细胞类型和潜在的干扰因素。
- 潜在的干扰因素包括脑部运动、Neuropil污染以及神经元间的反应变异性。

## 什么是钙成像？

钙成像是一项令人惊叹的技术。通过钙成像，我们可以记录活体动物神经元的活动，并在此过程中看到这些神经元。这些影像的迷人之处足以让我们立刻爱上这项技术。然而，从科学角度来看，我们的目标不仅仅是捕捉神经元闪烁的美丽画面，更要从中提取意义并解读结果——这需要几个步骤和一些背景知识。

其中一个处理步骤是计算归一化荧光强度 ∆F/F。为此，您需要获取随时间变化的荧光轨迹 F(t)，并计算 (F-F<sub>0</sub>)/F<sub>0</sub>，简写为 ∆F/F，其中 F<sub>0</sub> 是基线荧光。然而，似乎每篇论文在计算 F<sub>0</sub> 和 ∆F/F 时都采用了略微不同的流程。那么，**最可靠、最科学的方法是什么？更进一步说，我们当初为什么要使用这种归一化程序？最后，我们最终应该如何解读 ∆F/F？**

<video controls="controls" src="assets/Mouse blinking neurons-20250427164401-eag4hkq.mp4" data-src="assets/Mouse blinking neurons-20250427164401-eag4hkq.mp4"></video>

> 来源：[Mouse blinking neurons](https://www.youtube.com/watch?v=aldTVWsDMBY)
>
> 由 Sian Duss 和 Peter Rupprecht 记录的清醒小鼠海马 CA1 锥体细胞的钙成像视频。

## ∆F/F<sub>0</sub> 的历史渊源

### **为什么我们使用 ∆F/F**​**<sub>0</sub>** **进行归一化**

让我们从最简单的问题开始：为什么我们首先需要对荧光变化进行归一化？答案很简单：

不同神经元在同一照明和成像条件下可能具有不同的基础荧光强度（因为钙指示剂表达水平、细胞钙离子浓度差异、细胞环境差异等原因）。如果直接比较未归一化的荧光变化 (∆F)，一个本身就很亮的细胞即使有相对较小的钙浓度变化，其 ∆F 也可能比一个较暗的细胞在有较大钙浓度变化时的 ∆F 要大。这会导致误判细胞活动的相对强度。

好的。但为什么我们不能简单地通过记录轨迹的标准差（像 z-score 那样）或平均荧光强度来进行归一化呢？为什么我们需要使用基线 F<sub>0</sub>？这个问题可以通过回顾钙成像的历史来最好地回答。

历史上，∆F/F 直接与钙浓度的变化相关联。基线 F<sub>0</sub> 代表在理想情况下细胞无活动时观察到的钙浓度下的荧光值，任何低于此零水平的 F(t) 增加都表示相对于此基线水平的钙变化。

###  **∆F/F**​**<sub>0</sub>** **的线性和非线性区间**

然而，∆F/F 并不仅仅是钙浓度的线性函数。在[ 20 世纪 80 年代早期关于钙成像的论文](https://linkinghub.elsevier.com/retrieve/pii/S0021925819836414)中，首次给出了 [Ca<sup>2+</sup>] 作为 ∆F/F 函数的表达式。该方程基于钙离子和分子之间化学平衡的假设，每个分子结合一个钙离子。后来的工作将这种关系重塑为现在更[广为人知的形式](https://doi.org/10.1101/pdb.prot5649)：

$$
\frac{\Delta F}{F_{0}}=\frac{\Delta F_{\max }}{F_{0}}\frac{\left[\mathrm{Ca}^{2+}\right]}{\left[C
a^{2+}\right]+K_{d}}
$$

其中：

- F<sub>0</sub> 代表在理想情况下细胞处于无活动状态时（即细胞内钙离子浓度处于其基线水平时）钙指示剂所产生的荧光值。
- ∆F/F0 是归一化的荧光变化。
- ∆F<sub>max</sub> 是指示剂完全饱和时的最大荧光变化。
- [Ca²⁺] 是细胞内钙离子浓度。
- K<sub>d</sub> 是钙指示剂的解离常数，它反映了指示剂对钙的亲和力（K<sub>d</sub> 越低，亲和力越高）。

  > **如何理解解离常数 (Dissociation Constant)？**
  >
  > 来自AI解释：
  >
  > 以下是 K<sub>d</sub> 的详细解释及其在钙成像中的意义：
  >
  > 1. **化学基础：**  钙指示剂与钙离子的结合是一个可逆的化学反应：  
  >     指示剂 (Ind) + Ca²⁺ ⇌ 指示剂-钙复合物 (Ind·Ca)
  >
  >     解离常数 K<sub>d</sub> 描述的是这种结合反应的**解离**趋势。它在化学平衡时定义为：
  >
  >     $$
  >     K_d = \frac{[\text{Ind}][\text{Ca}^{2+}]}{[\text{Ind}\cdot\text{Ca}]}
  >     $$
  >
  >     其中，[Ind] 是未结合钙的游离指示剂浓度，[Ca²⁺] 是游离钙离子浓度，[Ind·Ca] 是指示剂-钙复合物的浓度。
  > 2. **衡量亲和力：**  K<sub>d</sub> 值是衡量指示剂与钙离子**亲和力**的关键指标。
  >
  >     - **K**​**<sub>d</sub>** **值越低**：表示指示剂与钙离子的亲和力越高，结合越紧密。在较低的钙离子浓度下，指示剂就能有效地结合钙离子并产生荧光信号变化。
  >     - **K**​**<sub>d</sub>** **值越高**：表示指示剂与钙离子的亲和力越低，结合越松散。需要更高的钙离子浓度才能使指示剂结合并产生明显的荧光信号变化。
  > 3. **K**​**<sub>d</sub>** **的特殊意义：**  根据公式 $\frac{\Delta F}{F_0}=\frac{\Delta F_{\max }}{F_0} \frac{\left[\mathrm{Ca}^{2+}\right]}{\left[C a^{2+}\right]+K_d}$，当细胞内的游离钙离子浓度 [Ca²⁺] **等于**该指示剂的 K<sub>d</sub> 值时，处于钙结合状态的指示剂分子的数量约为指示剂总分子数的一半（这取决于指示剂的设计，对于单钙结合位点指示剂通常是如此）。换句话说，K<sub>d</sub> 代表了使指示剂达到其最大荧光变化（∆F<sub>max</sub>/F0）**一半**所需的钙离子浓度。
  > 4. **选择指示剂的关键参数：**  在进行钙成像实验时，选择一个具有合适 K<sub>d</sub> 值的指示剂非常重要。理想情况下，指示剂的 K<sub>d</sub> 应该与您希望检测的生理钙浓度范围（例如，静息钙水平到活动高峰时的钙水平）大致匹配。
  >
  >     - 如果 K<sub>d</sub> 太高，指示剂对较低的生理钙变化可能不够敏感。
  >     - 如果 K<sub>d</sub> 太低，对钙变化会很敏感，但指示剂在生理性的钙活动高峰时可能很快饱和，无法区分不同强度的活动。
  >
  > 总之，K<sub>d</sub> 是钙指示剂的一个内禀属性，它量化了指示剂对钙离子的亲和力，并且决定了指示剂在不同钙浓度下的响应特性（线性或饱和），是在钙成像实验中选择合适探针的关键参数。
  >

当细胞内钙浓度远低于指示剂的解离常数时（即 $[C a^{2+}] \ll K_d$），上述公式可以近似为：

$$
\frac{\Delta F}{F_{0}}\approx \frac{\Delta F_{\max }}{F_{0}}\frac{\left[\mathrm{Ca}^{2+}\right]}{K_{d}}
$$

在这个“低钙浓度”区域，∆F/F₀ 近似地与 [Ca²⁺] **呈线性关系**。

当细胞内钙浓度远高于指示剂的解离常数时（即 $[C a^{2+}] \gg K_{d}$），指示剂达到饱和。此时，即使钙浓度继续增加，荧光变化 (∆F/F₀) 也趋于最大值 ∆F<sub>max</sub>/F0，不再随$[C a^{2+}]$​线性增加。这是一个非线性区域。

从这个方程及其假设可以得出几个关键结论：

第一，所有钙指示剂在高钙浓度时都会饱和，即 $\left[C a^{2+}\right] \gg k_{D}$ ，这可以由高放电频率引起。这个限制无法避免。

第二，这些钙指示剂仅在低钙浓度时呈线性，即 $\left[C a^{2+}\right] \ll k_{D}$。因此，不同细胞间变化的钙浓度范围以及钙指示剂的解离常数共同决定了每个细胞的线性和饱和区间。

第三，该方程源自反应平衡的假设。对于快速事件，如动作电位期间的钙内流，反应平衡在动作电位期间并未达到，因此该方程变得不那么精确，更具启发性。

第四，这个方程是在基因编码钙指示剂（如 GCaMP）尚处于起步阶段时推导和分析的。GCaMP 类传感器的特性并未被考虑在内。

总的来说，尽管存在局限性，但 ∆F/F 与钙浓度变化成正比的近似仍然是有用的。正是这一点使得 ∆F/F 比简单的 z-score 或原始荧光值更有意义。

## GCaMP 时代的 ∆F/F<sub>0</sub>

### **GCaMP 结合四个钙离子**

上述 ∆F/F 的方程基于假设单个钙离子与单个钙指示剂结合的模型。随着基因编码钙指示剂，特别是 GCaMP 的出现，这个假设不再有效。为什么？GCaMP 的不同之处在于它有四个钙离子结合位点。这些位点的结合并非独立，这种现象称为协同结合。描述这种协同结合的形式主义已经以 [Hill 方程](https://en.wikipedia.org/wiki/Hill_equation_$biochemistry$)的形式存在（您可能在研究氧气与血红蛋白的协同结合时见过这个方程！），它实际上是上述方程的推广：

$$
\frac{\Delta F}{F_0}=\frac{\Delta F_{\max }}{F_0} \frac{\left[\mathrm{Ca}^{2+}\right]^n}{\left[\mathrm{Ca}^{2+}\right]^n+K_d^n}
$$

其中 n 是结合位点的数量。在 *n*=1 的情况下，我们得到与上面相同的公式。GCaMP 有 4 个结合位点，但由于它们不是完全协同的，有效的 n（因此也是非线性程度）较低，对于 GCaMP 指示剂，其范围在 2-3 之间（例如，n<sub>GCaMP6f</sub> ≈ 2.3，n<sub>GCaMP7f</sub> ≈ 3.1，n<sub>GCaMP8s</sub> ≈ 2.2）。

### **GCaMP 的 S 型传递曲线**

这导致，钙-荧光关系现在呈 S 型，在 $\left[Ca^{2+}\right] > k_{D}$ 和 $\left[C a^{2+}\right] < k_{D}$ 时都呈非线性，而在 $\left[\mathrm{Ca}^{2+}\right] \approx k_{D}$ 附近有一个近似线性且高度敏感的工作范围。这种 S 型曲线关系在实践中可以看作是一种对比度增强器，在 Photoshop 或 GIMP 等图像处理软件中也有类似的应用。也许早期的 GCaMP 传感器之所以如此成功，不仅因为它们是伟大的工程杰作，还因为它们极大地增强了我们钙成像图像的对比度，在低活动水平和高活动水平之间形成了清晰而显著的过渡，从而产生了美丽的神经元闪烁现象。

![image](assets/image-20250427164807-9d7tx24.png "钙与荧光之间呈现非线性S形的关系，这在像GCaMP6f这样的钙离子指示剂中是典型的。kD表示钙离子指示剂的解离常数。S形变换相当于一种对比度增强的方法，这种方法在图像处理中常被采用：中间和右侧的图片拍摄于瑞士伦茨堡。
")

根据神经元的典型钙浓度如何与以 k<sub>D</sub> 为中心的 S 型曲线重叠，传感器将显示出不同的局限性。如果这种协同钙传感器的 k<sub>D</sub> 太低，它会在大量放电时迅速饱和。然而，如果这种传感器的 k<sub>D</sub> 太高，它对单个动作电位根本不会有反应。神经元的静息钙水平约为 50-200 nM，但可能因细胞和细胞类型而异。反过来，钙指示剂具有不同的 k<sub>D</sub> 值，这使得钙指示剂在神经元中通常遇到的钙范围内表现得或多或少线性：k<sub>D, GCaMP6f</sub> ≈ 375 nM, k<sub>D, GCaMP7f</sub> ≈ 150 nM, k<sub>D, GCaMP8s</sub> ≈ 46 nM。因此，要判断钙传感器的线性度，不能仅依赖于 Hill 系数，还需要考虑 k<sub>D</sub> 及其与目标神经元钙浓度范围的关系。

### **GCaMP 的低基线亮度**

像 GCaMP 这样的钙指示剂还有一个额外的问题，即在基线时（即钙处于静息水平时）亮度非常低。这个特性也带来了一个巨大的优势：它减少了来自沉默的神经元胞体或树突丛的背景荧光，从而使活动更加明显。然而，与此同时，计算 F<sub>0</sub> 值以获得定量结果变得具有挑战性。即使在确定背景荧光时出现微小的错误，也可能产生重大影响。而由于 PMT 偏移或神经纤维网污染等原因（见下文！），这类错误很可能发生。因此，准确确定 F<sub>0</sub> 是很棘手的，这反过来又使得定量解释 $\Delta F / F$ 值变得困难。

###  **∆F/F**​**<sub>0</sub>** **对 GCaMP 还有意义吗？**

那么，尽管存在这些局限性，我们为什么还要对 GCaMP 使用 ∆F/F 呢？我们使用它的主要原因确实是历史性的：

1. 它对以前使用的钙指示剂（如 Fluo-4 或 OGB-1）是有意义的，而我们只是沿用了这种做法。
2. 其次，我们需要某种形式的归一化，否则亮神经元总是会有大的响应，而暗神经元总是会有弱的响应。如果您改用 z-score，高活动细胞会被抑制，而沉默细胞会被人为放大。∆F/F 似乎也很直观，因为它是活性的正向度量，在没有活动时为零（至少对于活动模式稀疏的神经元而言）。
3. 第三，较新的 GCaMP 变体（GCaMP8s 和 GCaMP8m）似乎表现得更线性，这使得 ∆F/F 与钙的关系再次更具可解释性。因此，∆F/F 仍然或再次变得有用（另请参见下文“如何解读 ∆F/F”）。

## 如何计算 ∆F/F<sub>0</sub>

### **F**​**<sub>0</sub>** **可能受到背景干扰**

原则上，计算 ∆F/F 非常简单，正如公式 ∆F/F 所暗示的那样。那么，原则上，我们如何为一个原始提取的荧光轨迹计算 F<sub>0</sub> 呢？

F<sub>0</sub> 是神经元处于静息钙浓度状态时的基线荧光。然而，这个基线荧光可能会受到背景因素的干扰，这些背景值应该在计算 ∆F/F 之前 从记录中减去。不要混淆**基线 (baseline)**  和**背景 (background)**  —— 这是两个不同的概念。

首先，一个潜在的背景来源可能是记录或数字化设备的偏移。例如，流行的软件 ScanImage 允许减去一个“PMT 偏移”，这应该是 PMT 开启但未检测到任何荧光时的强度值；然而，该软件并不强制启用此功能，很容易发生人为添加负或正 PMT 偏移到整个图像的情况。在这种情况下，应努力在数据采集后估计 PMT 偏移并从原始数据中减去。类似的考虑也适用于使用其他软件或相机的钙成像。

![image](assets/image-20250427164918-wy21gd9.png "这是Scanimage（Vidrio Technology）软件的截图，该软件常用于记录双光子显微镜的数据。如果没有通过“Read Offsets”按钮测量或减去PMT偏置，数据中会出现一个无规律的偏置信号，作为仪器背景。
")

其次，来自其他细胞的荧光会干扰目标细胞的基线测量。例如，未聚焦但仍对每个像素贡献弥散且显著荧光的树突丛（被称为neuropil），可能会增加背景和估计的荧光值 F<sub>0</sub>。对于在神经元群体中密集表达的非核表达 GCaMP，这种效应无法完全避免。与此相关，像 Suite2p 这样的工具箱会执行neuropil subtraction来去除这种背景信号。然而，可能会发生neuropil subtraction过于激进并减去过多的情况，从而在相反方向上产生偏差。其他用于细胞提取的算法，如 CaImAn 和 EXTRACT，在执行源提取之前会减去背景模式。同样，如果这种全局背景减除过于激进，它也会减去神经元的真实基线荧光，导致 F<sub>0</sub> 的低估。

这些因素——PMT 偏移、neuropil污染和全局背景去除——需要根据需要进行调整或至少要牢记在心。总的来说，为了避免除以零，最好保持在安全范围内。例如，可以根据经验选择一个安全阈值，比如 10 或 20 个单位（或对您的数据有意义的任何值），添加到测量的 F<sub>0</sub> 值中，以防止潜在的除以（接近）零和噪声放大，甚至在 F<sub>0</sub> 为负值时出现符号反转。虽然对 F<sub>0</sub> 的任意添加很难从原则性方法上证明其合理性，但这可以作为解决 GCaMP 传感器低基线亮度问题的实用方案。

### **从中位数计算 F**​**<sub>0</sub>**

接下来，我们如何计算整个记录过程中的 F<sub>0</sub>？理论上，在没有噪声的情况下，整个记录中最低的荧光值应作为 F<sub>0</sub>。然而，还需要考虑噪声和潜在漂移的影响。有多种方法可以解决这些潜在问题。最简单的解决方案是计算原始荧光轨迹（“fluo\_trace”）的中位数：

Matlab：

```matlab
F0 = nanmedian(fluo_trace)
```

Python

```python
F0 = np.nanmedian(fluo_trace)
```

中位数作为一种所谓的“稳健”度量，**优于平均值**，因为荧光值的分布通常是偏态分布，活动期间表现为正向异常值。

### **从百分位数计算 F**​**<sub>0</sub>**

基于中位数的方法可以使用百分位数进行推广和改进：

Matlab：

```matlab
F0 = prctile(fluo_trace, 20) % Matlab
```

Python

```python
F0 = np.percentile(fluo_trace, 20)
```

当大量持续活动会将中位数推高到明显高于真实基线荧光的 F<sub>0</sub> 值时，使用例如 20% 的百分位数可能是有意义的。**由此可见，并不存在一个适用于所有记录的理想百分位数值**。

对于非常低的活动，50% 的百分位数是合适的（相当于取中位数），而**对于活动时间占比较高的记录，则应降低百分位数**。

此外，**对于噪声非常低的记录，较低的百分位数值可以得到最准确的 F**​<sub>**0**</sub> **值**。

另一方面，对于主要由散粒噪声主导的记录，较高的百分位数值更准确，而对于噪声水平甚至比真实信号更显著的情况，接近中位数的百分位数值在理论上是最佳选择。

简而言之，**对于较高的活动和较低的噪声（相对而言），您可以放心地降低百分位数，而对于较低的活动水平和较高的噪声水平，则需要将其提高到接近中位数**。

在实践中，**将计算出的 F**​<sub>**0**</sub> **与典型记录的荧光轨迹一起绘制出来**，并目测判断 F<sub>0</sub> 值是否确实是对基线荧光的良好估计，这是很有用的。

### **使用移动百分位数计算 F**​**<sub>0</sub>**

接下来，也可以计算**移动**百分位数或移动中位数，而不是简单的百分位数或中位数。

这种方法背后的思想是，基线 F<sub>0</sub> 存在缓慢的漂移，应该通过缓慢调整 F<sub>0</sub> 来加以考虑。这种方法目前是 CaImAn 或 Suite2p 等源提取软件包中最常用的方法，因为它在大多数情况下无害，并且可以避免漂移污染所有分析。这种漂移可能由多种原因引起。

首先，可能是由于荧光指示剂的漂白，这种效应是不希望看到的，因为它也会在同一次记录中降低信噪比。在这种情况下，通过指数或线性拟合进行归一化可能是补偿这种漂移的好方法。

或者，这种漂移也可能是由于观察到的神经元因头部固定装置的轻微不稳定性，或因决定扫描光束焦点的关键显微镜组件（如共振扫描器或可调谐透镜）升温而漂移出显微镜的焦点。理想情况下，这种焦点偏移应该在原始数据中检查并在实验过程中加以预防。如果在现有数据集中确实发生了这种小漂移——而且它们也可能在您不完全了解的情况下发生——移动百分位数是纠正它们的好方法，大多数标准工具箱（Suite2p、CaImAn、EXTRACT）都使用它们。下面是此类代码的示例。

Matlab:

```matlab
% 参数
w_size = 600; % 移动窗口大小(对于 30 帧/秒，为 20 秒)
q_value = 20; % 第 20 百分位数
x_w = floor(w_size/2); % 辅助变量
% 应用移动百分位数滤波器
F0 = arrayfun(@(x) prctile(fluo_trace(max(1,x-x_w):min(end,x+x_w)), q_value), 1:length(fluo_trace));
```

Python:

```python

import numpy as np
from scipy.ndimage import generic_filter
# 参数
window_size = 600 # 移动窗口大小 (对于 30 帧/秒，为 20 秒)
percentile_value = 20 # 第 20 百分位数
# 应用移动百分位数滤波器
F0 = generic_filter(fluorescence_trace, function=lambda x: np.percentile(x, percentile_value), size=window_size)
```

> 演示
>
> ```matlab
> % 清理工作空间和命令行窗口
> clear; clc; close all;
>
> %% 1. 生成模拟数据
> % 模拟一个带有变化基线、尖锐峰和噪声的信号
> N = 3000; % 数据点数量
> t = 1:N;  % 时间/索引向量
>
> % 模拟基线 (缓慢变化，例如一个平滑的曲线)
> % 我们可以用一个简单的函数来模拟，比如一个带有小波动的线性趋势
> baseline_true = 100 + 0.1 * t + 50 * sin(t/500);
>
> % 模拟信号峰 (例如，模拟一些实验中的尖峰信号)
> % 我们用几个高斯函数来模拟这些峰
> peaks_sum = zeros(1, N);
> % 定义几个峰的参数 [中心位置, 幅度, 宽度]
> peak_params = [
>     500, 150, 50;   % 第一个峰
>     1200, 120, 60;  % 第二个峰
>     2000, 180, 40;  % 第三个峰
>     2700, 100, 70   % 第四个峰
> ];
>
> % 叠加高斯峰
> for i = 1:size(peak_params, 1)
>     center = peak_params(i, 1);
>     amplitude = peak_params(i, 2);
>     width = peak_params(i, 3);
>     % 高斯函数: A * exp(-(x-mu)^2 / (2*sigma^2))
>     peaks_sum = peaks_sum + amplitude * exp(-(t - center).^2 / (2 * width^2));
> end
>
> % 添加噪声 (例如，模拟仪器噪声)
> noise_level = 20; % 噪声的幅度
> noise = noise_level * randn(1, N); % 生成高斯白噪声
>
> % 将基线、峰和噪声组合成最终的模拟信号
> fluo_trace = baseline_true + peaks_sum + noise;
>
> %% 2. 应用移动百分位数滤波器 (使用您提供的代码)
>
> % 参数
> w_size = 600; % 移动窗口大小。窗口越大，对缓慢基线的跟踪越平滑，但对快速变化的基线响应越慢，且边缘效应影响范围越大。
> q_value = 20; % 第 q_value 百分位数。通常选择一个较低的百分位数（如10%-30%）来估计基线，因为它不容易受到高幅值峰的影响。
> x_w = floor(w_size/2); % 辅助变量：窗口半宽度
>
> % 应用移动百分位数滤波器
> % arrayfun 对数组的每个元素应用一个函数。这里对索引 1 到 length(fluo_trace) 的每个 x 应用一个函数。
> % 对于每个索引 x，函数提取以 x 为中心（并处理边界）的窗口数据，并计算其 q_value 百分位数。
> % max(1, x-x_w) 确保窗口起始索引不小于 1
> % min(end, x+x_w) 确保窗口结束索引不大于数组末尾
> disp('正在应用移动百分位数滤波器...');
> tic; % 计时开始
> F0 = arrayfun(@(x) prctile(fluo_trace(max(1,x-x_w):min(end,x+x_w)), q_value), 1:length(fluo_trace));
> toc; % 计时结束
> disp('滤波器应用完成。');
>
> %% 3. 绘制结果以展示效果
>
> figure; % 创建一个新的图形窗口
> hold on; % 允许在同一图上绘制多个图形
>
> % 绘制原始模拟信号
> plot(t, fluo_trace, 'b', 'DisplayName', '原始模拟信号', 'LineWidth', 0.8);
>
> % 绘制真实的基线 (用于比较，实际中通常不知道真实的基线)
> plot(t, baseline_true, 'k--', 'DisplayName', '真实基线', 'LineWidth', 1.5);
>
> % 绘制滤波器计算出的基线估计 (F0)
> plot(t, F0, 'r', 'DisplayName', sprintf('滤波结果 (移动 %d 百分位数)', q_value), 'LineWidth', 1.5);
>
> % 添加图例、标题和轴标签
> xlabel('数据点索引');
> ylabel('值');
> title('移动百分位数滤波器效果演示');
> legend('Location', 'best'); % 在最佳位置显示图例
> grid on; % 添加网格线
>
> hold off; % 停止在同一图上绘制
>
>
>
> %% 4. 计算 Delta F over F
> % 计算 Delta F (信号减去基线)
> delta_F = fluo_trace - F0;
>
> % 计算 Delta F / F (Delta F 除以基线)
> % 注意使用 ./ 进行元素级的除法
> % 确保 F0 不为零，在大多数实际荧光数据中，基线估计值通常是正的
> delta_F_over_F = delta_F ./ F0;
>
> %% 5. 绘制 Delta F over F 结果
>
> figure; % 创建一个新的图形窗口
>
> % 绘制 Delta F / F 曲线
> plot(t, delta_F_over_F, 'g', 'DisplayName', '\DeltaF/F', 'LineWidth', 1);
>
> % 添加图例、标题和轴标签
> xlabel('数据点索引');
> ylabel('\DeltaF/F'); % 使用 Delta F / F 的标准标记
> title('信号的 \DeltaF/F (使用移动百分位数基线)');
> legend('Location', 'best'); % 在最佳位置显示图例
> grid on; % 添加网格线
>
> % 可选：如果需要将 Y 轴转换为百分比，可以修改 ylabel 和数据
> % ylabel('\DeltaF/F (%)');
> % plot(t, delta_F_over_F * 100, 'g', 'DisplayName', '\DeltaF/F (%)', 'LineWidth', 1);
>
>
> ```
>
> ![image](https://fastly.jsdelivr.net/gh/Achuan-2/PicBed@pic/assets/image-20250427181136-qbokaxs.png)
>
> ![image](https://fastly.jsdelivr.net/gh/Achuan-2/PicBed@pic/assets/image-20250427181128-0yd8ahc.png)

用于这些移动窗口的典型时间窗口大约是 20 或 60 秒——远慢于在皮层锥体神经元中观察到的大多数钙瞬变。然而，在其他中枢神经系统区域（例如脊髓）、其他神经元类型（例如快放电中间神经元）以及其他细胞类型（例如星形胶质细胞）中，钙信号或其基础的放电活动可能在慢得多的时间尺度上变化。对于从去甲肾上腺素或乙酰胆碱等神经调节剂记录的信号，情况也常常如此。在这种情况下，应仔细调整移动滤波器，以免意外去除缓慢变化的生物信号。

行为小鼠海马 CA1 区不同细胞类型的钙成像。**锥体神经元**的活动是稀疏的，因此**计算 F**​<sub>**0**</sub> **的移动窗口不需要超过 10-20 秒**。**对于选定的中间神经元或星形胶质细胞**，20 秒的移动窗口会减去缓慢演变的真实钙变化，因此需要更长的时间窗口来计算移动平均 F<sub>0</sub> 。

![image](https://fastly.jsdelivr.net/gh/Achuan-2/PicBed@pic/assets/image-20250427164957-qm92wle.png "数据由")

‍

在缓慢变化的生物信号和例如由于漂白引起的漂移同时发生的情况下，必须非常谨慎地对观察结果做出结论。或者，更直接地说，如果您看到缓慢变化的神经元活动，您必须说服自己十次，才能确定这种缓慢变化确实是生物来源的！

### **从刺激前时间窗口计算 F**​**<sub>0</sub>**

最后，还有一种常见的做法是，不针对整个记录计算 F<sub>0</sub>，而是基于感兴趣时间窗口（例如，重复的行为试验开始或重复的感觉刺激）之前的短时间窗口来计算。这种基于刺激前窗口的归一化可用于系统地去除任何类型的漂移。

关键点在于：**这种基于试验的 F**​<sub>**0**</sub> **基线计算还是其他 F**​<sub>**0**</sub> **定义更好，取决于该分析所要回答的生物学问题**。

在刺激前窗口归一化下，重点是测量相对于刺激前窗口的活动变化。在另一种情况（全局归一化）下，重点是测量相对于更全局基线的活动变化，这样就可以更直接地比较重复刺激窗口之间的活动。

最终，计算 F<sub>0</sub> 没有一刀切的方法——选择取决于噪声特性、活动水平和细胞类型，也取决于正在研究的生物学问题。

## 如何解读 ∆F/F

### **某个 ∆F/F 值意味着什么？**

分析 ∆F/F 最困难的部分是其解读。核心问题是：某个特定的 ∆F/F 瞬变意味着什么？它反映的是单个放电、多个放电，还是一长串放电？

简短的回答是：**视情况而定**。

详细的回答是：这取决于细胞类型、脑区、钙指示剂，可能还有其他因素。在实践中，特别是对于像 GCaMP6f 这样的指示剂，皮层锥体神经元中孤立的钙瞬变通常是由一簇放电引起的，而不是单个孤立的放电。

### **利用基准实测数据理解 ∆F/F**

为了直观理解放电和钙瞬变之间的关系，我建议查看直接测量了这种关系的数据（所谓的“基准实测 (ground truth)”记录）。Adrian Roggenbach 和我建立了一个可在线浏览的[数据库](https://colab.research.google.com/github/HelmchenLabSoftware/Cascade/blob/master/Demo%20scripts/Explore_ground_truth_datasets.ipynb)，欢迎您根据需要使用或修改！

首先，重要的是要理解，峰值 ∆F/F 幅度为 30% 的瞬变在一个神经元中可能由单个放电引起，而在另一个神经元中可能由两个放电引起，这在不同细胞类型和钙指示剂之间也可能不同。以下是一些经验法则：

- 对于常用的 GCaMP6，可见的最小瞬变通常不是反映单个放电，而是放电簇。这是由于 GCaMP6 的非线性和 k<sub>D</sub> 值。对于 GCaMP8m 和 GCaMP8s，可见的最小瞬变更常由单个放电引起。
- **直接比较神经元对之间的 ∆F/F 值是有问题的**，因为静息钙浓度或细胞内在缓冲能力可能因细胞而异。此外，由于基线荧光低，很难确定 GCaMP 指示剂的 F<sub>0</sub>。
- 单个放电可以触发峰值幅度通常为 GCaMP6 的 10-50% 或 GCaMP8 的 30-80% 的钙瞬变。这只是一个数量级，因为它取决于细胞类型、GCaMP 的变体，并且依赖于 F<sub>0</sub> 的确定，而如上所述，这很困难。
- 到目前为止讨论的值适用于皮层锥体神经元（第 2/3 层）。对于像快放电中间神经元这样的不同细胞类型，单个放电诱发的 ∆F/F 瞬变几乎只有该值的 1/10。因此，快放电中间神经元中显著的钙瞬变应被解释为反映了至少 10-30 次放电，并且由于其幅度小，使用标准群体成像无法分辨单个放电。这就是为什么在不同细胞类型和脑区进行此类基准实测至关重要。

### **从 ∆F/F 数据推断放电**

除了对 ∆F/F 进行这种定性解释之外，还可以使用放电推断算法，这些算法通常会估计绝对放电频率。我自己研究过一种基于深度学习的算法（CASCADE），但也有其他使用建模方法的算法（例如 MLSpike）。这两种算法的共同点是，它们都通过基准实测记录进行校准和优化，即同时从同一个神经元记录钙信号和电生理信号。即使使用经过良好校准的算法得到的推断放电频率，仍必须将其视为带有不确定性的估计值。根据我的经验，推断的放电频率可能会有 2 倍的误差，即在真实估计值的 50% 到 200% 之间。当将放电推断应用于未经相应算法优化的脑区、钙指示剂或其他条件时，可能还会存在额外的偏差。

此外，一些放电推断方法，如 CaImAn 或 Suite2p 使用的标准方法，不对放电频率进行定量估计，因此至少不会出错。然而，我个人相信，推动定量和校准的放电推断是有意义的，以便未来使钙成像更具可解释性。这是我发现非常令人兴奋的一个活跃的未来研究领域。这不仅需要更线性的钙指示剂和对神经元间钙反应变异性的更好理解，还需要更好的算法。

### **解读中的常见陷阱**

我将只简要提及在解读 ∆F/F 数据时需要考虑的其他几个方面。例如，文献中有许多关于 ∆F/F 值负向偏转的报道，通常被解释为抑制。在许多情况下，这些也可能是脑部运动伪影或分析伪影。原则上，当基线放电频率不为零时，负向偏转是可能的，但有两个观察结果表明负向偏转是伪影：首先，如果负向偏转的起始时间与正向偏转一样快；由于钙指示剂较慢的关闭动力学，这不符合预期。其次，如果正向和负向调制的神经元数量大致相等，这表明在脑部运动期间，一半的神经元跳出焦点，另一半跳入焦点。

Neuropil是通常无法分辨的神经元突起，它们会产生模糊的背景。因此，特定神经元的时间轨迹可能会受到这种背景的污染。将神经元活动与背景分离原则上很困难，因为两者的活动可能相关。根据脑区、活动模式和标记密度，人们可以忽略这个问题，或者使用线性减除Neuropil背景成分的方法（由 Suite2p、CaImAn 或 FISSA 等工具箱完成）。另一种方法是仅使用钙指示剂的胞体表达，从而在实验上阻止信号渗漏。

最后，任何测量都会同时对被测物产生干扰。钙指示剂的表达可能通过多种方式干扰自然的活动模式，在某些情况下甚至导致癫痫或其他异常活动模式。这些效应尚未完全阐明。然而，普遍接受的观点是，过表达和典型的钙指示剂“核填充”是神经元健康状况不佳的迹象。高表达水平也直接影响钙动力学，因为这些过表达的钙指示剂会作为缓冲剂结合钙离子，从而减慢表观的钙动力学。也就是说，如果您看到非常缓慢和持久的瞬变，您可能过表达了您的钙指示剂。

## 结语

总的来说，与任何技术一样，钙成像也有其局限性和注意事项。任何优秀的实验者或数据分析师都应该意识到这些，并不断学习。因为只有当我们理解了我们的工具及其局限性，我们才能自信地使用它们，并精确地解读生物学结果。从我个人的角度来看，即使在与钙成像打交道超过十年，涉及不同物种、脑区、细胞类型和钙指示剂之后，我仍然时常能学到一些新东西。

## 关于作者

Peter Rupprecht 是苏黎世大学的一位青年课题组长。他研究神经元中的钙信号及其与动作电位和可塑性的关系，以及星形胶质细胞中的钙信号。此外，Peter 还运营着一个关于神经科学和神经技术的[博客](http://www.gcamp6f.com/)。您可以在 bioRxiv 上阅读他最新的工作：[利用 GCaMP8 指示剂采集的钙成像数据进行放电推断](https://www.biorxiv.org/content/10.1101/2025.03.03.641129)。
